name: Release

on:
  release:
    types:
      - published

permissions:
  contents: write

jobs:
  validate:
    name: Check validate status
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    outputs:
      release_sha: ${{ steps.resolve_tag.outputs.sha }}
    steps:
      - name: Resolve release tag to commit
        id: resolve_tag
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const tag = context.payload.release.tag_name;
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `tags/${tag}`,
            });
            let sha = ref.object.sha;
            if (ref.object.type === "tag") {
              const { data: tagObject } = await github.rest.git.getTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_sha: ref.object.sha,
              });
              sha = tagObject.object.sha;
            }
            core.setOutput("sha", sha);

      - name: Verify Validate workflow success
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const workflowName = "Validate";
            const sha = "${{ steps.resolve_tag.outputs.sha }}";
            const { data: workflows } = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const workflow = workflows.workflows.find((item) => item.name === workflowName);
            if (!workflow) {
              core.setFailed(`Workflow not found: ${workflowName}`);
              return;
            }

            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow.id,
              head_sha: sha,
              per_page: 100,
            });
            const successful = runs.workflow_runs.find(
              (run) => run.status === "completed" && run.conclusion === "success",
            );
            if (!successful) {
              const summary = runs.workflow_runs
                .map((run) => `${run.status}/${run.conclusion || "none"} (${run.html_url})`)
                .join(", ");
              core.setFailed(
                `No successful Validate run found for ${sha}. Runs: ${summary || "none"}`,
              );
            }

  build-release:
    needs: [validate]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          ref: ${{ needs.validate.outputs.release_sha }}
      - name: Set up Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "24"
          cache: "yarn"
          cache-dependency-path: custom_components/city_visitor_parking/frontend/yarn.lock
      - name: Install frontend dependencies (locked)
        if: ${{ hashFiles('custom_components/city_visitor_parking/frontend/yarn.lock') != '' }}
        run: yarn install --non-interactive --frozen-lockfile
        working-directory: custom_components/city_visitor_parking/frontend
      - name: Install frontend dependencies
        if: ${{ hashFiles('custom_components/city_visitor_parking/frontend/yarn.lock') == '' }}
        run: yarn install --non-interactive
        working-directory: custom_components/city_visitor_parking/frontend
      - name: Build frontend
        run: yarn build
        working-directory: custom_components/city_visitor_parking/frontend
      - name: Build release asset
        run: |
          git -C custom_components/city_visitor_parking archive --format=zip \
            --output ../../city_visitor_parking.zip \
            --worktree-attributes \
            HEAD
      - name: Upload release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload "${{ github.event.release.tag_name }}" city_visitor_parking.zip --clobber
      - name: Publish release
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              draft: false,
            });
